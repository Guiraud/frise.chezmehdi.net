image: node:18-alpine

# Cache node_modules for faster builds
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/

# Define pipeline stages
stages:
  - install
  - quality
  - build
  - deploy

# Variables
variables:
  NODE_ENV: production
  NPM_CONFIG_CACHE: .npm
  CYPRESS_CACHE_FOLDER: .cache/cypress

# Install dependencies
install:
  stage: install
  script:
    - npm ci --cache .npm --prefer-offline
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# Quality checks stage
lint:
  stage: quality
  script:
    - npm run lint || echo "No lint script found, skipping linting"
  dependencies:
    - install
  only:
    - main
    - develop
    - merge_requests
  allow_failure: true

# Type checking (if TypeScript)
typecheck:
  stage: quality
  script:
    - npm run type-check || npm run typecheck || echo "No type checking script found, skipping"
  dependencies:
    - install
  only:
    - main
    - develop
    - merge_requests
  allow_failure: true

# Unit tests
test:
  stage: quality
  script:
    - npm run test || npm run test:unit || echo "No test script found, skipping tests"
  dependencies:
    - install
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests
  allow_failure: true

# Build for production
build:
  stage: build
  script:
    - echo "Building for environment: $NODE_ENV"
    - npm run build
    - echo "Build completed successfully"
    - ls -la dist/
  dependencies:
    - install
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# Build preview for merge requests
build_preview:
  stage: build
  script:
    - echo "Building preview for merge request"
    - NODE_ENV=development npm run build
  dependencies:
    - install
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  only:
    - merge_requests
  when: manual

# Deploy to Cloudflare Pages (main branch)
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to Cloudflare Pages..."
    - |
      if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ACCOUNT_ID" ] && [ -n "$CLOUDFLARE_PROJECT_NAME" ]; then
        # Install wrangler CLI
        curl -sL https://github.com/cloudflare/wrangler2/releases/latest/download/wrangler-linux-x64 -o wrangler
        chmod +x wrangler
        
        # Deploy to Cloudflare Pages
        ./wrangler pages publish dist --project-name=$CLOUDFLARE_PROJECT_NAME
        echo "Deployment to Cloudflare Pages completed"
      else
        echo "Cloudflare configuration missing. Skipping deployment."
        echo "Please set CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID, and CLOUDFLARE_PROJECT_NAME variables"
      fi
  dependencies:
    - build
  environment:
    name: production
    url: https://frise.chezmehdi.net
  only:
    - main
  when: manual

# Deploy preview for develop branch
deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying staging version..."
    - |
      if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ACCOUNT_ID" ] && [ -n "$CLOUDFLARE_PROJECT_NAME" ]; then
        curl -sL https://github.com/cloudflare/wrangler2/releases/latest/download/wrangler-linux-x64 -o wrangler
        chmod +x wrangler
        ./wrangler pages publish dist --project-name=$CLOUDFLARE_PROJECT_NAME --branch=develop
        echo "Staging deployment completed"
      else
        echo "Cloudflare configuration missing. Skipping staging deployment."
      fi
  dependencies:
    - build
  environment:
    name: staging
    url: https://develop.frise.chezmehdi.net
  only:
    - develop
  when: manual
